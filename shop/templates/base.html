{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8">
    <title>{% block title %}ุงุฑุงู ูุงุฑฺฉุช | ูุฑูุดฺฏุงู ุขููุงู{% endblock %}</title>
    <meta name="description"
          content="{% block meta_description %}ุฎุฑุฏ ุขููุงู ููุงุฏ ุบุฐุง ู ูุญุตููุงุช ุณููพุฑูุงุฑฺฉุช ุงุฒ ุงุฑุงู ูุงุฑฺฉุช ุจุง ุงุฑุณุงู ุณุฑุน ู ููุช ููุงุณุจ.{% endblock %}">
    
    {% block extra_head %}{% endblock %}

    {# Bootstrap 5 RTL #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    {# ูููุช ูุงุฑุณ Vazirmatn #}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    {# ุงุณุชุงูโูุง ุงุฎุชุตุงุต ุงุฑุงู ูุงุฑฺฉุช #}
    <link rel="stylesheet" href="{% static 'shop/css/styles.css' %}">

    {% block extra_css %}{% endblock %}
</head>
<body>

{# ูุฏุฑ ุณุงุช โ ุจุง sticky-top ุชุง ููุดู ุจุงูุง ุตูุญู ุจูุงูุฏ #}
<header class="im-header shadow-sm bg-white">
    {# ุฑุฏู ุจุงูุง: ููฺฏู / ุฌุณุชุฌู / ุญุณุงุจ ฺฉุงุฑุจุฑ / ุณุจุฏ ุฎุฑุฏ #}
    <div class="im-topbar border-bottom">
        <div class="container d-flex align-items-center justify-content-between gap-3 flex-wrap">

            {# ููฺฏู + ูุงู ูุฑูุดฺฏุงู #}
            <a href="{% url 'shop:home' %}" class="d-flex align-items-center gap-2 text-decoration-none text-dark">
                <div class="im-logo-circle d-flex align-items-center justify-content-center">
                    <span class="fw-bold text-white">IM</span>
                </div>
                <span class="fw-bold im-store-name">
                    ุงุฑุงู ูุงุฑฺฉุช
                </span>
            </a>

            {# ุจุงฺฉุณ ุฌุณุชุฌู #}
            <form
                action="{% url 'shop:product_search' %}"
                method="get"
                class="im-search flex-grow-1 mx-md-3 order-3 order-md-2"
            >
                <div class="input-group">
                    <input
                        name="q"
                        class="form-control form-control-sm"
                        type="search"
                        placeholder="ุฌุณุชุฌู ูุญุตููุ ุจุฑูุฏ ุง ุฏุณุชู..."
                        value="{{ request.GET.q }}"
                    >
                    <button class="btn btn-sm btn-outline-secondary" type="submit">
                        ๐
                    </button>
                </div>
            </form>

            {# ุงุนูุงูโูุง / ูุฑูุฏ ุง ุญุณุงุจ ฺฉุงุฑุจุฑ / ุณุจุฏ ุฎุฑุฏ #}
            <div class="d-flex align-items-center gap-2 order-2 order-md-3">

                <button type="button" class="btn btn-sm im-icon-btn" title="ุงุนูุงูโูุง">
                    ๐
                </button>

                {% if request.user.is_authenticated %}
                    <a href="{% url 'shop:account_dashboard' %}" class="btn btn-sm im-login-btn">
                        ุญุณุงุจ ฺฉุงุฑุจุฑ
                    </a>
                {% else %}
                    <a href="{% url 'shop:login' %}" class="btn btn-sm im-login-btn">
                        ูุฑูุฏ / ุซุจุชโูุงู
                    </a>
                {% endif %}

                {# ุณุจุฏ ุฎุฑุฏ ุจุง ุงุณุชุงู ูุดุงุจู ุฏฺฉูู ุญุณุงุจ ฺฉุงุฑุจุฑ + ุดูุงุฑูุฏู #}
                <a href="{% url 'shop:cart_detail' %}"
                   class="btn btn-sm im-login-btn position-relative d-inline-flex align-items-center gap-2">
                    <span class="d-inline-flex align-items-center gap-1">
                        <span class="small">ุณุจุฏ ุฎุฑุฏ</span>
                        <span>๐</span>
                    </span>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        <span id="cart-count">{{ cart|length }}</span>
                    </span>
                </a>

            </div>

        </div>
    </div>

    {# ุฑุฏู ูพุงู: ููู ูุงูุจุฑ + ุงูุชุฎุงุจ ุดูุฑ #}
    <nav class="im-nav-cats">
        <div class="container py-1 d-flex align-items-center justify-content-between gap-3 flex-wrap small">

            {# ุขุชูโูุง ููู #}
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <a href="{% url 'shop:category_list' %}" class="im-nav-link text-decoration-none">
                    ุฏุณุชูโุจูุฏ ฺฉุงูุงูุง
                </a>

                <a href="{% url 'shop:offers_list' %}" class="im-nav-link text-decoration-none">
                    ูพุดููุงุฏ ูฺู
                </a>

                <a href="{% url 'shop:new_products' %}" class="im-nav-link text-decoration-none">
                    ุฌุฏุฏุชุฑูโูุง
                </a>

                <a href="{% url 'shop:best_sellers' %}" class="im-nav-link text-decoration-none">
                    ูพุฑูุฑูุดโุชุฑูโูุง
                </a>

                {# ุณูุงู ุฏุงุฑุฏุ โ ุงฺฏุฑ ูุงฺฏู ูุณุชุ ุจู ูุงฺฏู ุจุฑูุฏ #}
                {% if request.user.is_authenticated %}
                    <a href="{% url 'shop:account_support' %}" class="im-nav-link text-decoration-none">
                        ุณูุงู ุฏุงุฑุฏุ
                    </a>
                {% else %}
                    {# ุจุง next ฺฉุงุฑุจุฑ ุจุนุฏ ุงุฒ ูุงฺฏู ุจุฑูโฺฏุฑุฏู ุจู ุตูุญู ูพุดุชุจุงู #}
                    <a href="{% url 'shop:login' %}?next={% url 'shop:account_support' %}"
                       class="im-nav-link text-decoration-none">
                        ุณูุงู ุฏุงุฑุฏุ
                    </a>
                {% endif %}
            </div>

            {# ุงูุชุฎุงุจ ุดูุฑ #}
            <button
                type="button"
                class="btn btn-sm im-city-pill"
                id="citySelectButton"
                data-bs-toggle="modal"
                data-bs-target="#citySelectModal"
            >
                ๐
                <span id="citySelectLabel">
                    {% if current_city %}
                        {{ current_city.name }}
                    {% else %}
                        ุดูุฑ ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
                    {% endif %}
                </span>
            </button>

        </div>
    </nav>
</header>

{# ูพุงูโูุง ููููุด #}
{% if messages %}
    <div class="container mt-2">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} py-2 small mb-2">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<main class="pb-5 im-main">
    {% block content %}{% endblock %}
</main>

<footer class="im-footer border-top mt-5 pt-4 pb-4 bg-light">
    <div class="container">
        <div class="row g-4 small">

            {# ุณุชูู ฑ: ุจุฑูุฏ ู ุชูุถุญ ฺฉูุชุงู #}
            <div class="col-12 col-md-4">
                <p class="mb-1 fw-bold">
                    ุงุฑุงู ูุงุฑฺฉุช
                </p>

                <p class="mb-2 text-muted">
                    ุณููพุฑูุงุฑฺฉุช ุขููุงู ุจุง ุงุฑุณุงู ุณุฑุนุ ููุช ููุตูุงูู ู ุชุถูู ุชุงุฒฺฏ ูุญุตููุงุช.
                </p>

                <ul class="list-unstyled mb-0 text-muted">
                    <li>โ ุงุฑุณุงู ุณุฑุน ุฏุฑ ุดูุฑูุง ุชุญุช ูพูุดุด</li>
                    <li>โ ุชุถูู ุชุงุฒฺฏ ู ุชุงุฑุฎ ุงููุถุง</li>
                    <li>โ ูพุดุชุจุงู ูุงูุน ูุดุชุฑ</li>
                </ul>
            </div>

           {# ุณุชูู ฒ: ููฺฉโูุง ุฑุงูููุง #}
            <div class="col-6 col-md-2">
                <p class="fw-bold mb-2">ุฑุงูููุง ุฎุฑุฏ</p>
                <ul class="list-unstyled mb-0">
                    <li>
                        <a href="{% url 'shop:about' %}" class="text-decoration-none text-muted">
                            ุฏุฑุจุงุฑู ูุง
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'shop:buying_guide' %}" class="text-decoration-none text-muted">
                            ุฑุงูููุง ุฎุฑุฏ
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'shop:shipping_methods' %}" class="text-decoration-none text-muted">
                            ุฑูุดโูุง ุงุฑุณุงู
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'shop:return_policy' %}" class="text-decoration-none text-muted">
                            ุดุฑุงุท ุจุงุฒฺฏุดุช ฺฉุงูุง
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'shop:faq' %}" class="text-decoration-none text-muted">
                            ุณูุงูุงุช ูุชุฏุงูู
                        </a>
                    </li>
                </ul>
            </div>

           {# ุณุชูู ณ: ูพุดุชุจุงู ู ุชูุงุณ #}
            <div class="col-6 col-md-3">
                <p class="fw-bold mb-2">ูพุดุชุจุงู ูุดุชุฑุงู</p>

                <p class="mb-1">
                    ๐ ุชููู:
                    <span class="fw-semibold">09175018865</span>
                </p>

                <p class="mb-1">
                    ๐ ุขุฏุฑุณ:
                    ุจูุฏุฑุนุจุงุณุ ฺฏูุดูุฑ ุฌููุจุ ุฎุงุจุงู ุญฺฉูุชุ ุฎุงุจุงู ุณุนุงุฏุช
                </p>

                <p class="mb-1">
                    ๐ ุงุฑุณุงู ุณูุงุฑุดโูุง ูููโุฑูุฒู ุฏุฑ ุณุฑุนโุชุฑู ุฒูุงู ููฺฉู
                </p>

                <p class="mb-0 text-muted">
                    ุณุงุนุช ูพุงุณุฎโฺฏู:
                    <span class="fw-semibold">ธ ุตุจุญ ุชุง ฑฒ ุดุจ</span>
                </p>
            </div>


           {# ุณุชูู ด: ุดุจฺฉูโูุง ุงุฌุชูุงุน #}
            <div class="col-12 col-md-3">
                <p class="fw-bold mb-2">ูุง ุฑุง ุฏุฑ ุดุจฺฉูโูุง ุงุฌุชูุงุน ุฏูุจุงู ฺฉูุฏ</p>

                <div class="d-flex flex-wrap gap-2 mb-3">
                    <a href="https://instagram.com/iranmarket" target="_blank"
                    class="btn btn-sm btn-outline-secondary">
                        ๐ธ ุงูุณุชุงฺฏุฑุงู
                    </a>
                    <a href="https://wa.me/989121234567" target="_blank"
                    class="btn btn-sm btn-outline-secondary">
                        ๐ฌ ูุงุชุณุงูพ
                    </a>
                </div>

                <p class="small text-muted mb-1">
                    ูพุดููุงุฏูุง ู ุชุฎููโูุง ูฺู ุฑุง ุฒูุฏุชุฑ ุงุฒ ุจูู ุจุจูุฏ โจ
                </p>
            </div>


        </div>

        <hr class="my-3">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center small text-muted">
            <p class="mb-1 mb-md-0">
                ยฉ {% now "Y" %} ุงุฑุงู ูุงุฑฺฉุช โ ููู ุญููู ูุญููุธ ุงุณุช.
            </p>
            <p class="mb-0">
                <!-- ุงูุฌุง ุจุนุฏุงู ูโุชูู ููฺฏู ููุงุฏ ุงุนุชูุงุฏ / ุฒุฑูโูพุงู / ุฏุฑฺฏุงูโูุง ุฑู ุจุฐุงุฑ -->
                ุฑูุดโูุง ูพุฑุฏุงุฎุช ุงูู
            </p>
        </div>
    </div>
</footer>


{# Bootstrap JS #}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{# Modal ุงูุชุฎุงุจ ุดูุฑ #}
<div
    class="modal fade"
    id="citySelectModal"
    tabindex="-1"
    aria-labelledby="citySelectModalLabel"
    aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-scrollable modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="citySelectModalLabel">ุงูุชุฎุงุจ ุดูุฑ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ุจุณุชู"></button>
      </div>

      <div class="modal-body">

        {# ุณุฑฺ ุดูุฑูุง #}
        <div class="mb-3">
          <input
              type="text"
              id="citySearchInput"
              class="form-control form-control-sm"
              placeholder="ุฌุณุชุฌู ุฏุฑ ุงุณุชุงูโูุง ู ุดูุฑูุง ุงุฑุงู"
          >
        </div>

        <p class="small text-muted mb-2">
          ุจุฑุง ูุดุงูุฏู ุชุฎููโูุง ู ฺฉุงูุงูุง ูุงุจู ุงุฑุณุงู ุจู ุดูุฑ ุดูุงุ ุขู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.
        </p>

        {# ุดูุฑูุง ูพุฑุชฺฉุฑุงุฑ #}
        <h6 class="small fw-bold mt-3 mb-2">ุดูุฑูุง ูพุฑุชฺฉุฑุงุฑ</h6>
        <div class="d-flex flex-wrap gap-2 mb-3">
          {% for province in province_list %}
            {% for city in province.cities.all %}
              {% if city.is_active and city.is_popular %}
                <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary city-chip"
                    data-city="{{ city.name }}"
                    data-city-id="{{ city.id }}"
                >
                  {{ city.name }}
                </button>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </div>

        {# ูุณุช ููู ุดูุฑูุง #}
        <h6 class="small fw-bold mt-3 mb-2">ููู ุดูุฑูุง</h6>
        <div class="list-group small" id="cityList">
          {% for province in province_list %}
            {% for city in province.cities.all %}
              {% if city.is_active %}
                <button
                    type="button"
                    class="list-group-item list-group-item-action city-item"
                    data-city="{{ city.name }}"
                    data-city-id="{{ city.id }}"
                >
                  {{ city.name }} ุฏุฑ {{ province.name }}
                </button>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </div>

      </div>

      <div class="modal-footer">
        <form id="setCityForm" method="post" action="{% url 'shop:set_city' %}">
          {% csrf_token %}
          <input type="hidden" name="city_id" id="selectedCityIdInput">
          <input type="hidden" name="next" value="{{ request.path }}">
        </form>
        <small class="text-muted">
          ูุฑ ุฒูุงู ุฎูุงุณุชุฏ ูโุชูุงูุฏ ุดูุฑ ุฎูุฏ ุฑุง ุฏูุจุงุฑู ุชุบุฑ ุฏูุฏ.
        </small>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var labelEl      = document.getElementById("citySelectLabel");
    var searchInput  = document.getElementById("citySearchInput");
    var cityButtons  = document.querySelectorAll(".city-item, .city-chip");
    var formEl       = document.getElementById("setCityForm");
    var cityIdInput  = document.getElementById("selectedCityIdInput");
    var modalEl      = document.getElementById("citySelectModal");
    var modalInstance = null;

    if (modalEl && typeof bootstrap !== "undefined") {
        modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    }

    // ุงฺฏุฑ ูุจูุงู ุดูุฑ ุฏุฑ localStorage ุฐุฎุฑู ุดุฏู ุจูุฏ
    if (labelEl) {
        var currentLabel = labelEl.textContent.trim();
        var storedCity   = localStorage.getItem("iranmarket_selected_city");
        if (storedCity && (!currentLabel || currentLabel === "ุดูุฑ ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ")) {
            labelEl.textContent = storedCity;
        }
    }

    // ฺฉูฺฉ ุฑู ูุฑ ุดูุฑ
    cityButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
            var cityName = this.getAttribute("data-city");
            var cityId   = this.getAttribute("data-city-id");
            if (!cityName || !cityId) return;

            if (labelEl) {
                labelEl.textContent = cityName;
            }

            localStorage.setItem("iranmarket_selected_city", cityName);

            if (formEl && cityIdInput) {
                cityIdInput.value = cityId;
                formEl.submit();
            }

            if (modalInstance) {
                modalInstance.hide();
            }
        });
    });

    // ุณุฑฺ ุฏุฑ ูุณุช ุดูุฑูุง
    if (searchInput) {
        searchInput.addEventListener("input", function () {
            var term = this.value.trim().toLowerCase();
            cityButtons.forEach(function (btn) {
                var text = btn.textContent.trim().toLowerCase();
                if (!term || text.indexOf(term) !== -1) {
                    btn.classList.remove("d-none");
                } else {
                    btn.classList.add("d-none");
                }
            });
        });
    }
});
</script>

{# ุงุณฺฉุฑูพุช ุณุจุฏ ุฎุฑุฏ AJAX ุจุฑุง ููู ุตูุญุงุช #}
<script src="{% static 'shop/js/cart.js' %}"></script>

{% block extra_js %}{% endblock %}
</body>
</html>
